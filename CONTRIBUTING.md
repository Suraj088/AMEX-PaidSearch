# Contributing Guide

## Project and build process logistics explained

### TL;DR

This project essentially does static site generation using Nunjucks and Webpack. Styling is done
primarily through the inclusion of Amex's DLS and custom styling in a Sass format that builds on top
of the former. Client-side rendering, which first and foremost drives the dynamic card comparison
portion, is done with Preact.

If not familiar with any of these projects or technologies, please review the documentation for each
project, respectively.

### Source code location and access

The source code is in a Gitlab repository at the URL below. To gain access to it, please contact
Dentsu IT.

```sh
https://gitlab.com/weareswirl/amex/mbbi-0252-paid-search
```

### Common development commands

```sh
# Production quality build
npm run build

# Start development server
npm run serve

# Run code linting
npm run lint

# Run code formatting validation (without formatting)
npm run format:check

# Run code formatting
npm run format
```

### Build output contents

- **For production**
  - `low-funnel-*.html`: The pages to be served for low-funnel prospects.
  - `assets/*`: A directory containing all images, video, and other media assets output.
  - `main.[hash].js`: Main JS entry. Note that the hash may change between builds if there are any
    changes in the dependency graph.
  - `styles.[hash].css`: Main CSS entry. Note that the hash may change between builds if there are
    any changes in the dependency graph.
- **For reference (NOT production)**
  - `index.html`: A helper page that merely serves as an index to point to the low-funnel pages.
  - `single-*.html`: Auxiliary pages to preview card data in an individual fashion.
  - `card-data.html`: Page with guidance for other teams to interact with this project's features at
    runtime, as well as text areas to copy-paste page data when needed.
  - `card-data.json`: Exposes card data in a JSON for external consumption.
  - `card-hero-data.json`: Exposes card category hero data in a JSON for external consumption.

### Static template rendering

Template rendering is primarily done via Nunjucks and Webpack. To understand how this occurs in
detail, please review the following parts of the `webpack.config.js` file:

- The `htmlWebpackPlugins` array spread into the `plugins` array.
- The `njk` module rule which defines how each Nunjucks template is processed.
- Related to how Nunjucks templates are rendered, the `njkEnvironment` near the top of the file.

Additionally, it will be highly beneficial to be familiar with Nunjucks (or a similar template
engine). The main files that concern template rendering are the following:

- Templates
  - Entries, located in `./src/views/*.njk`.
  - Partials, located in `./src/partials/*.njk`. These are the building blocks used by the templated
    above, and generally represent page "chunks" laid out down the page.
- Data
  - Global data (`./src/global.data.js`) which will be provided to all templates when rendering.
  - Local data (`./src/views/*.data.js`) which can complement the global data as needed on a
    template by template basis.
  - Card data (`./src/card-data/*.data.js`) which is the core Amex credit card details that will be
    provided to the templates to build the card comparison potions of the pages. The model for these
    is the `CardDynamicData` interface referenced at the top of each of these pages.
    - **Note:** There are a couple of card data entries in this directory that are currently unused,
      but they're kept here for reference since they could be brought into rotation in the future.
      These unused cards won't be exposed unless referenced in the global or local data files.

### Styling

There is one main CSS bundle that's generated by this project. It uses Sass in its build process and
its main entrypoint for it is in `./src/styles.scss`.

### Client-side scripting

There is one main JavaScript bundle that's generated by this project to do client-side rendering. It
uses Typescript in its build process and its main entrypoint for it is in `./src/main.ts`. In broad
terms, this bundle relates to the following functionality:

1. **The dynamic card comparison rendering.** Largely, this uses Preact for rendering and a
   `MutationObserver` to observe a container (`#data-container`) in the DOM as a data source.
2. **Emitting card category change events**. Enables the emission of a custom event when engaging
   with the card category items at the top of the page. Other teams can use this to navigate or
   change the dynamically rendered cards just by listening to these events.

Guidance for other teams to interact with these features is documented in `card-data.njk`, which
will be rendered as `card-data.html` after the project is built.

## Deployment

### Dentsu staging

For staging purposes within Dentsu (and Dentsu subsidiaries), Netlify is used. Netlify access is not
strictly required for this, since it's integrated into the repo's CI/CD, i.e., deployment will occur
in the following fashion:

- Pushing to `master` will build and deploy to `https://mbbi-0252-paid-search.netlify.app`
- Pull Requests will build and deploy preview environments
  `https://deploy-preview-*--mbbi-0252-paid-search.netlify.app/`

Netlify will install dependencies, build the project (`npm run build`), and deploy the artifacts
accordingly. Additionally, as defined in the `netlify.toml`, it will serve the pages with a
`X-Robots-Tag: noindex` header to avoid being indexed, since these are purely for staging purposes.

### Amex staging

For Amex staging purposes the `master` branch needs to be pushed to another repo. At the time of
this writing, that is `https://github.com/iquanti-dev/amex-paid-search/`, which is managed by the
iQuanti team. They use a semi-automatic deployment in that it's scripted but not automatically
initiated; to initiate deployment, iQuanti needs to be notified to take action.
